# HerEcho 产品需求文档

- 重要：本项目所有前端必须符合商业级项目的美术要求，必须使用tailwind风格进行开发，必须使用统一的图标库。

## 1. 页面功能描述

### 1.1 剧本列表页面 (ScriptListView)

#### 功能描述
- 作为应用的首页，展示所有可用的剧本
- 提供剧本的视觉化展示和快速访问

#### 组件结构
- `ScriptListView.vue`: 主视图组件
- `ScriptCard.vue`: 剧本卡片组件
- `ScriptDetailModal.vue`: 剧本详情弹窗组件
- `CharacterSelect.vue`: 角色选择组件

#### 数据服务
- `scriptService.ts`: 剧本数据管理服务
  - 从 `stories` 表获取剧本列表和详情
  - 支持分页查询和排序
  - 缓存常用剧本数据
  - 处理剧本封面图片的存储和访问

- `characterService.ts`: 角色数据管理服务
  - 从 `characters` 表获取角色信息
  - 管理角色配置（system_prompt, voice_id等）
  - 处理角色头像的存储和访问
  - 缓存角色数据以提高性能

#### 交互流程
1. 页面加载时获取所有剧本数据
2. 展示剧本卡片列表，包括：
   - 自定义剧本卡片（无封面）
   - 标准剧本卡片（带封面图）
3. 点击剧本卡片触发详情弹窗
4. 在详情弹窗中选择角色并开始对话

### 1.2 剧本详情弹窗 (ScriptDetailModal)

#### 功能描述
- 展示剧本的详细信息
- 提供角色选择功能
- 提供开始对话的入口

#### 组件结构
- `ScriptDetailModal.vue`: 详情弹窗组件
- `CharacterSelect.vue`: 角色选择下拉组件
- `ScriptInfo.vue`: 剧本信息展示组件

#### 数据服务
- `scriptService.ts`: 剧本详情数据服务
- `characterService.ts`: 角色列表数据服务

#### 交互流程
1. 展示剧本封面图
2. 展示剧本名称和介绍
3. 加载并展示可选角色列表（基于剧本的id，查找该剧本的所有角色，然后返回角色名字和图片，加载进下拉框）
4. 用户选择角色后启用"开始对话"按钮
5. 点击"开始对话"进入对应角色对话页面

### 1.3 角色对话页面 (ChatView)

#### 功能描述
- 提供与选定角色的对话界面
- 支持多种输入方式
- 提供自动回复选项
- 支持聊天容器的动态调整

#### 组件结构
- `ChatView.vue`: 主视图组件
- `TopBar.vue`: 顶部导航栏组件，包括左侧的"角色选择组件"，右侧的"更多设置按钮"
- 'SettingBar.vue': 位于右侧的设置列表，点击更多设置后展开，平时隐藏。包括大模型选项（用于切换使用的大模型，目前支持deepseek和gemini）、角色语音自动播放选项（用于控制是否自动播放角色的回答）、api测试按钮（用于测试api连接情况，点击后右侧显示转圈加载动画，得到结果后显示连接正常或连接失败）、对话模式切换（可以选择剧情模式和日常模式，现在默认日常模式，点击剧情模式选项会显示开发中，不予切换）。
- `ScriptInfoBar.vue`: 剧本信息栏组件，用于显示当前对话的剧情阶段、进度条。仅在剧情模式下开启，暂不开发。
- `ChatContainer.vue`: 中间主体部分是聊天容器组件，用于展示与角色的对话。这个聊天容器可以通过容器右上角的收起、展开按钮调整占据页面的大小。
- `InputArea.vue`: 输入区域组件，包括一个语音/键盘切换按钮、输入栏、自动回复选项按钮。
- 'CharacterChatBubble.vue': 角色消息记录气泡组件，用于显示角色的对话消息内容。包括左侧的角色头像、一个消息气泡、左上角的语音图标（用于展示角色语音播放，并且可以通过点击进行停止播放，再次点击可以从头播放）
- 'UserChatBubble.vue': 用户消息记录气泡组件，用于显示用户的对话消息内容。
- 'SysMessage.vue': 系统消息提示组件（居中显示的气泡，用于展示系统提示消息，比如报错）
- 'IntroductionBubble.vue': 对话简介气泡组件（在对话开始时显示，居中的大气泡，用于介绍对话的背景信息）
- `AutoReplyOptions.vue`: 自动回复选项组件，是一个小的按钮图标，用于展示自动回复情况，并允许交互。在自动回复生成中时，它会显示加载中；自动回复生成完后，点击可以展开选项列表，点击选项可以发送；点击图标或其他任意位置可以收起选项列表。

#### 数据服务
- `chatPromptService.ts`: 用于构建输入给大模型的prompt
  - 从 `characters` 表获取角色system_prompt
  - 从 `chat_messages` 表获取历史对话记录
  - 组合对话预设提示词
  - 记录token使用量到 `user_chat_stats` 表

- `autoReplyOptionService.ts`: 用于构建输入给大模型的prompt
  - 从 `characters` 表获取角色system_prompt
  - 从 `chat_messages` 表获取历史对话记录
  - 组合选项预设提示词
  - 记录token使用量到 `user_chat_stats` 表

- `messageService.ts`: 消息处理服务
  - 在 `chat_messages` 表记录消息
  - 更新 `user_chat_stats` 表的统计信息
  - 处理消息的存储和检索
  - 管理会话状态和消息索引

- `ttsService.ts`: 文本转语音服务
  - 从 `characters` 表获取语音参数
  - 管理语音文件的存储和访问
  - 记录语音生成错误到 `error_logs` 表
  - 优化语音缓存策略

- `ttsCacheService.ts`: 语音缓存服务
  - 管理语音文件的缓存存储
  - 定期清理过期缓存
  - 优化缓存访问性能
  - 处理缓存错误和异常

- `userService.ts`: 用户管理服务
  - 管理 `users` 表的用户信息
  - 处理用户认证和授权
  - 管理 `user_subscriptions` 表的订阅信息
  - 处理用户状态更新

- `errorService.ts`: 错误处理服务
  - 记录错误信息到 `error_logs` 表
  - 处理错误通知和告警
  - 提供错误统计和分析
  - 管理错误日志的清理

#### 交互流程
1. 页面布局：
   - 顶部导航栏
   - 剧本信息栏
   - 聊天容器（可调整大小）
   - 输入区域
   背景是固定的角色图片
2. 输入功能：
   - 文本输入
   - 语音/键盘切换
   - 自动回复选项
3. 聊天容器控制：
   - 展开/收起功能
   - 消息展示
   - 滚动加载历史消息


## 2. 组件详细说明

### 2.1 剧本列表组件
- 支持网格布局展示剧本卡片
- 自定义剧本卡片特殊样式处理
- 响应式布局适配不同屏幕尺寸

### 2.2 剧本详情组件
- 模态框展示
- 支持图片预览
- 角色选择下拉框
- 开始对话按钮状态管理

### 2.3 对话页面组件
- 固定顶部导航
- 可折叠的聊天容器
- 多模式输入支持
- 实时消息更新
- 自动回复选项生成

## 3. 数据流设计

### 3.1 剧本数据流
- 剧本列表获取
- 剧本详情加载
- 角色列表关联

### 3.2 对话数据流
- 消息发送与接收
- 历史消息加载
- 自动回复生成
- 状态同步

## 4. 技术实现要点

### 4.1 前端实现
- Vue 3 组件化开发
- TypeScript 类型支持
- 响应式布局设计
- 状态管理方案

### 4.2 后端服务
- 剧本管理服务
- 角色管理服务
- 对话管理服务
- 自动回复服务

### 4.3 数据存储
- 剧本数据模型
- 角色数据模型
- 对话历史模型
- 用户配置模型 

## 5. 数据库操作流程

### 5.1 剧本列表页面数据库操作

#### 剧本数据获取
1. 从 `stories` 表获取所有剧本信息：
   - 查询字段：id, book_id, title, cover_image, description
   - 按创建时间倒序排序
   - 支持分页查询

#### 角色数据关联
1. 根据剧本ID从 `characters` 表获取相关角色：
   - 查询字段：id, name, character_image
   - 使用 book_id 关联查询
   - 缓存角色数据以提高性能

### 5.2 剧本详情弹窗数据库操作

#### 剧本详情获取
1. 从 `stories` 表获取单个剧本详细信息：
   - 使用 book_id 精确查询
   - 返回完整剧本信息

#### 角色列表获取
1. 从 `characters` 表获取该剧本的所有角色：
   - 使用 book_id 关联查询
   - 返回角色基本信息用于展示

### 5.3 角色对话页面数据库操作

#### 对话初始化
1. 用户认证：
   - 从 `users` 表验证用户身份
   - 检查用户状态（active/inactive/banned）
   - 验证用户订阅状态（从 `user_subscriptions` 表）

2. 角色信息加载：
   - 从 `characters` 表获取角色完整信息
   - 包括：system_prompt, voice_id, voice_speed, voice_pitch, voice_volume
   - 缓存角色配置以提高性能

#### 对话消息处理
1. 消息存储：
   - 在 `chat_messages` 表记录每条消息
   - 包含：session_id, user_id, character_id, message_index, content, source
   - 记录使用的token数量

2. 对话统计：
   - 在 `user_chat_stats` 表记录统计信息
   - 统计消息类型和token使用量
   - 按会话ID和用户ID分组

#### 错误处理
1. 错误日志记录：
   - 在 `error_logs` 表记录错误信息
   - 包含：user_id, session_id, error_type, error_message, stack_trace
   - 用于问题追踪和系统监控

### 5.4 数据维护流程

#### 定期清理
1. 对话历史清理：
   - 清理30天前的 `chat_messages` 记录
   - 清理90天前的 `user_chat_stats` 记录
   - 清理90天前的 `error_logs` 记录

#### 订阅管理
1. 订阅状态更新：
   - 定期检查 `user_subscriptions` 表
   - 更新过期订阅状态
   - 处理订阅续费

#### 性能优化
1. 索引维护：
   - 定期检查索引使用情况
   - 优化查询性能
   - 清理无用索引

### 5.5 数据安全

#### 用户数据保护
1. 密码安全：
   - 使用加密存储密码哈希
   - 定期更新密码策略

2. 数据访问控制：
   - 基于用户角色的数据访问限制
   - 敏感数据脱敏处理

#### 数据备份
1. 定期备份：
   - 全量数据备份
   - 增量数据备份
   - 备份文件加密存储

2. 数据恢复：
   - 定期测试数据恢复流程
   - 维护恢复文档 