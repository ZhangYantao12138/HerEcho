# HerEcho 产品需求文档

- 重要：本项目所有前端必须符合商业级项目的美术要求，必须使用tailwind风格进行开发，必须使用统一的图标库。

## 1. 页面功能描述

### 1.1 剧本列表页面 (ScriptListView)

#### 功能描述
- 作为应用的首页，展示所有可用的剧本
- 提供剧本的视觉化展示和快速访问

#### 组件结构
- `ScriptListView.vue`: 主视图组件
- `ScriptCard.vue`: 剧本卡片组件
- `ScriptDetailModal.vue`: 剧本详情弹窗组件
- `CharacterSelect.vue`: 角色选择组件

#### 数据服务
- `scriptService.ts`: 剧本数据管理服务
- `characterService.ts`: 角色数据管理服务

#### 交互流程
1. 页面加载时获取所有剧本数据
2. 展示剧本卡片列表，包括：
   - 自定义剧本卡片（无封面）
   - 标准剧本卡片（带封面图）
3. 点击剧本卡片触发详情弹窗
4. 在详情弹窗中选择角色并开始对话

### 1.2 剧本详情弹窗 (ScriptDetailModal)

#### 功能描述
- 展示剧本的详细信息
- 提供角色选择功能
- 提供开始对话的入口

#### 组件结构
- `ScriptDetailModal.vue`: 详情弹窗组件
- `CharacterSelect.vue`: 角色选择下拉组件
- `ScriptInfo.vue`: 剧本信息展示组件

#### 数据服务
- `scriptService.ts`: 剧本详情数据服务
- `characterService.ts`: 角色列表数据服务

#### 交互流程
1. 展示剧本封面图
2. 展示剧本名称和介绍
3. 加载并展示可选角色列表（基于剧本的id，查找该剧本的所有角色，然后返回角色名字和图片，加载进下拉框）
4. 用户选择角色后启用"开始对话"按钮
5. 点击"开始对话"进入对应角色对话页面

### 1.3 角色对话页面 (ChatView)

#### 功能描述
- 提供与选定角色的对话界面
- 支持多种输入方式
- 提供自动回复选项
- 支持聊天容器的动态调整

#### 组件结构
- `ChatView.vue`: 主视图组件
- `TopBar.vue`: 顶部导航栏组件，包括左侧的"角色选择组件"，右侧的"更多设置按钮"
- 'SettingBar.vue': 位于右侧的设置列表，点击更多设置后展开，平时隐藏。包括大模型选项（用于切换使用的大模型，目前支持deepseek和gemini）、角色语音自动播放选项（用于控制是否自动播放角色的回答）、api测试按钮（用于测试api连接情况，点击后右侧显示转圈加载动画，得到结果后显示连接正常或连接失败）、对话模式切换（可以选择剧情模式和日常模式，现在默认日常模式，点击剧情模式选项会显示开发中，不予切换）。
- `ScriptInfoBar.vue`: 剧本信息栏组件，用于显示当前对话的剧情阶段、进度条。仅在剧情模式下开启，暂不开发。
- `ChatContainer.vue`: 中间主体部分是聊天容器组件，用于展示与角色的对话。这个聊天容器可以通过容器右上角的收起、展开按钮调整占据页面的大小。
- `InputArea.vue`: 输入区域组件，包括一个语音/键盘切换按钮、输入栏、自动回复选项按钮。
- 'CharacterChatBubble.vue': 角色消息记录气泡组件，用于显示角色的对话消息内容。包括左侧的角色头像、一个消息气泡、左上角的语音图标（用于展示角色语音播放，并且可以通过点击进行停止播放，再次点击可以从头播放）
- 'UserChatBubble.vue': 用户消息记录气泡组件，用于显示用户的对话消息内容。
- 'SysMessage.vue': 系统消息提示组件（居中显示的气泡，用于展示系统提示消息，比如报错）
- 'IntroductionBubble.vue': 对话简介气泡组件（在对话开始时显示，居中的大气泡，用于介绍对话的背景信息）
- `AutoReplyOptions.vue`: 自动回复选项组件，是一个小的按钮图标，用于展示自动回复情况，并允许交互。在自动回复生成中时，它会显示加载中；自动回复生成完后，点击可以展开选项列表，点击选项可以发送；点击图标或其他任意位置可以收起选项列表。

#### 数据服务
- `chatPromptService.ts`: 用于构建输入给大模型的prompt。会从数据库调用**用户所对话**的角色对应的提示词，再组合历史对话记录，以及统一的对话预设提示词，结合这三部分构建出用于输入给大模型的prompt。
- `autoReplyOptionService.ts`: 用于构建输入给大模型的prompt。会从数据库调用**用户所扮演**的角色对应的提示词，再组合历史对话记录，以及统一的选项预设提示词，结合这三部分构建出用于输入给大模型的prompt。
- `messageService.ts`: 消息处理服务。根据对话进展产生对应信号（在用户发送气泡后，产生“用户对话信号”，在角色完整生成气泡后，产生“角色对话信号”。并接收这些信号，基于逻辑调用其他几个服务。并且，接收大模型的回复，根据不同情况做出处理。（角色流式回复：需要做流式的对应处理，让他可以正确显示在气泡中，并输送给气泡组件；自动回复选项：需要把长文本根据固定格式拆成几条信息，变成可以显示在对应组件的格式，并返回给组件）
- `deepseekStreamService.ts`: 结合prompt，从根目录的env获取api，从根目录的AIconfig文件获取参数，构建用于传送给deepseek的流式回复的请求头
- `deepseekService.ts`: 结合prompt，从根目录的env获取api，从根目录的AIconfig文件获取参数，构建用于传送给deepseek的非流式请求头
- `geminiStreamService.ts`: 结合prompt，从根目录的env获取api，从根目录的AIconfig文件获取参数，构建用于传送给gemini的l流式服务的请求头
- `geminiService.ts`: 结合prompt，从根目录的env获取api，从根目录的AIconfig文件获取参数，构建用于传送给gemini的请求头
- `ttsService.ts`: 文本转语音服务。负责将角色的回复文本转换为语音，并管理语音缓存。主要功能包括：
  - 文本转语音：调用 MiniMax TTS API 将文本转换为语音
  - 语音缓存：缓存已生成的语音，避免重复请求
  - 语音参数管理：管理不同角色的语音参数（语速、音调、音量等）
  - 语音播放控制：提供语音播放、暂停、继续、停止等控制功能
  - 错误处理：处理 TTS API 调用失败、网络错误等异常情况
- `ttsCacheService.ts`: 语音缓存服务。负责管理语音文件的缓存，提高应用性能和用户体验：
  - 缓存管理：存储和检索已生成的语音文件
  - 缓存清理：定期清理过期或不再使用的缓存文件
  - 缓存状态：维护缓存文件的状态（生成中、已完成、错误等）
  - 缓存配置：管理缓存相关的配置（存储位置、过期时间等）

#### 交互流程
1. 页面布局：
   - 顶部导航栏
   - 剧本信息栏
   - 聊天容器（可调整大小）
   - 输入区域
   背景是固定的角色图片
2. 输入功能：
   - 文本输入
   - 语音/键盘切换
   - 自动回复选项
3. 聊天容器控制：
   - 展开/收起功能
   - 消息展示
   - 滚动加载历史消息


## 2. 组件详细说明

### 2.1 剧本列表组件
- 支持网格布局展示剧本卡片
- 自定义剧本卡片特殊样式处理
- 响应式布局适配不同屏幕尺寸

### 2.2 剧本详情组件
- 模态框展示
- 支持图片预览
- 角色选择下拉框
- 开始对话按钮状态管理

### 2.3 对话页面组件
- 固定顶部导航
- 可折叠的聊天容器
- 多模式输入支持
- 实时消息更新
- 自动回复选项生成

## 3. 数据流设计

### 3.1 剧本数据流
- 剧本列表获取
- 剧本详情加载
- 角色列表关联

### 3.2 对话数据流
- 消息发送与接收
- 历史消息加载
- 自动回复生成
- 状态同步

## 4. 技术实现要点

### 4.1 前端实现
- Vue 3 组件化开发
- TypeScript 类型支持
- 响应式布局设计
- 状态管理方案

### 4.2 后端服务
- 剧本管理服务
- 角色管理服务
- 对话管理服务
- 自动回复服务

### 4.3 数据存储
- 剧本数据模型
- 角色数据模型
- 对话历史模型
- 用户配置模型 